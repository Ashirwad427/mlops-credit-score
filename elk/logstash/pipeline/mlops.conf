# Logstash Pipeline Configuration for MLOps Application
# This pipeline processes logs from the MLOps application

input {
  # Beats input for Filebeat
  beats {
    port => 5044
    tags => ["beats"]
  }
  
  # TCP input for direct log shipping (JSON format)
  tcp {
    port => 5045
    codec => json_lines
    tags => ["tcp", "json"]
  }
  
  # File input for reading log files directly
  file {
    path => "/var/log/mlops/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json {
      target => "log_data"
    }
    tags => ["file", "mlops"]
    type => "mlops-application"
  }
}

filter {
  # Parse JSON logs from MLOps application
  if [log_data] {
    mutate {
      rename => { "[log_data][@timestamp]" => "@timestamp" }
      rename => { "[log_data][level]" => "level" }
      rename => { "[log_data][message]" => "message" }
      rename => { "[log_data][logger]" => "logger" }
      rename => { "[log_data][app]" => "app" }
      rename => { "[log_data][module]" => "module" }
      rename => { "[log_data][function]" => "function" }
      rename => { "[log_data][extra]" => "extra" }
    }
  }
  
  # Handle MLOps application logs
  if [app] == "mlops-credit-score" {
    mutate {
      add_field => { 
        "application" => "mlops-credit-score"
        "environment" => "${ENVIRONMENT:production}"
      }
    }
    
    # Tag prediction events
    if [extra][event_type] == "prediction" {
      mutate {
        add_tag => ["prediction", "ml-inference"]
      }
      
      # Extract prediction details
      if [extra][prediction] {
        mutate {
          add_field => { "prediction_class" => "%{[extra][prediction]}" }
        }
      }
      
      if [extra][latency_ms] {
        mutate {
          add_field => { "latency_ms" => "%{[extra][latency_ms]}" }
        }
        mutate {
          convert => { "latency_ms" => "float" }
        }
      }
    }
    
    # Tag training events
    if [extra][event_type] == "training" {
      mutate {
        add_tag => ["training", "ml-training"]
      }
      
      if [extra][model_name] {
        mutate {
          add_field => { "model_name" => "%{[extra][model_name]}" }
        }
      }
    }
    
    # Tag error events
    if [extra][event_type] == "error" {
      mutate {
        add_tag => ["error", "alert"]
      }
    }
  }
  
  # Handle container logs from Docker
  if [docker][container][name] {
    mutate {
      add_field => { "container_name" => "%{[docker][container][name]}" }
    }
  }
  
  # Parse timestamp
  date {
    match => ["@timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ"]
    target => "@timestamp"
  }
  
  # Add geo information if IP is present
  if [client_ip] {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
  
  # Remove unnecessary fields
  mutate {
    remove_field => ["host", "agent", "ecs", "input", "log_data"]
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["${ELASTICSEARCH_HOST:elasticsearch}:${ELASTICSEARCH_PORT:9200}"]
    index => "mlops-logs-%{+YYYY.MM.dd}"
    
    # Index template
    template_name => "mlops-logs"
    template_overwrite => true
  }
  
  # Separate index for predictions (for ML monitoring)
  if "prediction" in [tags] {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOST:elasticsearch}:${ELASTICSEARCH_PORT:9200}"]
      index => "mlops-predictions-%{+YYYY.MM.dd}"
    }
  }
  
  # Separate index for training events
  if "training" in [tags] {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOST:elasticsearch}:${ELASTICSEARCH_PORT:9200}"]
      index => "mlops-training-%{+YYYY.MM.dd}"
    }
  }
  
  # Separate index for errors (for alerting)
  if "error" in [tags] {
    elasticsearch {
      hosts => ["${ELASTICSEARCH_HOST:elasticsearch}:${ELASTICSEARCH_PORT:9200}"]
      index => "mlops-errors-%{+YYYY.MM.dd}"
    }
  }
  
  # Debug output (disable in production)
  # stdout {
  #   codec => rubydebug
  # }
}
